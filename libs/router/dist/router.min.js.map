{"version":3,"file":"router.min.js","sources":["../../../packages/stanz/public.mjs","../init-router.mjs","../../../packages/xhear/public.mjs","../router.mjs"],"sourcesContent":["export const getRandomId = () => Math.random().toString(32).slice(2);\n\nconst objectToString = Object.prototype.toString;\nexport const getType = (value) =>\n  objectToString\n    .call(value)\n    .toLowerCase()\n    .replace(/(\\[object )|(])/g, \"\");\n\nexport const isObject = (obj) => {\n  const type = getType(obj);\n  return type === \"array\" || type === \"object\";\n};\n\nexport const isDebug = {\n  value: null,\n};\n\nif (typeof document !== \"undefined\") {\n  if (document.currentScript) {\n    isDebug.value = document.currentScript.attributes.hasOwnProperty(\"debug\");\n  } else {\n    isDebug.value = true;\n  }\n}\n\nlet asyncsCounter = 0;\nlet afterTimer;\nconst tickSets = new Set();\nexport function nextTick(callback) {\n  clearTimeout(afterTimer);\n  afterTimer = setTimeout(() => {\n    asyncsCounter = 0;\n  });\n\n  if (isDebug.value) {\n    Promise.resolve().then(() => {\n      asyncsCounter++;\n      if (asyncsCounter > 100000) {\n        const desc = `nextTick exceeds thread limit`;\n        console.error({\n          desc,\n          lastCall: callback,\n        });\n        throw new Error(desc);\n      }\n\n      callback();\n    });\n    return;\n  }\n\n  const tickId = `t-${getRandomId()}`;\n  tickSets.add(tickId);\n  Promise.resolve().then(() => {\n    asyncsCounter++;\n    // console.log(\"asyncsCounter => \", asyncsCounter);\n    if (asyncsCounter > 50000) {\n      tickSets.clear();\n      const desc = `nextTick exceeds thread limit`;\n      console.error({\n        desc,\n        lastCall: callback,\n      });\n      throw new Error(desc);\n    }\n    if (tickSets.has(tickId)) {\n      callback();\n      tickSets.delete(tickId);\n    }\n  });\n  return tickId;\n}\n\n// export const clearTick = (id) => tickSets.delete(id);\n\nexport function debounce(func, wait = 0) {\n  let timeout = null;\n  let hisArgs = [];\n\n  return function (...args) {\n    hisArgs.push(...args);\n\n    if (wait > 0) {\n      clearTimeout(timeout);\n      timeout = setTimeout(() => {\n        func.call(this, hisArgs);\n        hisArgs = [];\n        timeout = null;\n      }, wait);\n    } else {\n      if (timeout === null) {\n        timeout = 1;\n        nextTick(() => {\n          timeout = null;\n          const args = hisArgs.slice();\n          hisArgs = [];\n          func.call(this, args);\n        });\n      }\n    }\n  };\n}\n\n// Enhanced methods for extending objects\nexport const extend = (_this, proto, descriptor = {}) => {\n  [\n    ...Object.getOwnPropertyNames(proto),\n    ...Object.getOwnPropertySymbols(proto),\n  ].forEach((k) => {\n    const result = Object.getOwnPropertyDescriptor(proto, k);\n    const { configurable, enumerable, writable, get, set, value } = result;\n\n    if (\"value\" in result) {\n      if (_this.hasOwnProperty(k)) {\n        _this[k] = value;\n      } else {\n        Object.defineProperty(_this, k, {\n          enumerable,\n          configurable,\n          writable,\n          ...descriptor,\n          value,\n        });\n      }\n    } else {\n      Object.defineProperty(_this, k, {\n        enumerable,\n        configurable,\n        ...descriptor,\n        get,\n        set,\n      });\n    }\n  });\n\n  return _this;\n};\n\nexport function dataRevoked(data) {\n  try {\n    data.xid;\n  } catch (err) {\n    return isRevokedErr(err);\n  }\n\n  return false;\n}\n\nexport function isRevokedErr(error) {\n  const firstLine = error.stack.split(/\\\\n/)[0].toLowerCase();\n  if (firstLine.includes(\"proxy\") && firstLine.includes(\"revoked\")) {\n    return true;\n  }\n\n  return false;\n}\n","import { isSafariBrowser } from \"../../packages/xhear/public.mjs\";\n\nexport default function initRouter({ app, getStateUrl, fixStateUrl }) {\n  if (history.state && history.state.routerMode) {\n    app.routers = history.state.routers;\n  }\n\n  // Application fallback, no window.history operation required\n  let _isFixState;\n  // When history moves forward\n  let _isGoto;\n  // When the address is back\n  let _isBack;\n  // when there is historical data, re-entering the hash address, it is necessary to replace the blank history\n  let _isFixNavigate;\n\n  app.on(\"router-change\", (e) => {\n    let methodName = \"pushState\";\n    const { name, delta, src } = e.data || {};\n\n    switch (name) {\n      case \"replace\":\n        methodName = \"replaceState\";\n      case \"goto\":\n        const { routers } = app;\n\n        const { pathname, search, origin } = new URL(src, location.href);\n\n        if (_isGoto) {\n          _isGoto = null;\n          return;\n        }\n\n        let hUrl = \"\";\n\n        if (getStateUrl) {\n          hUrl = getStateUrl(pathname, search, methodName);\n        } else if (location.origin === origin) {\n          hUrl = `#${pathname}${search}`;\n        } else {\n          hUrl = `#${origin}${pathname}${search}`;\n        }\n\n        if (_isFixNavigate) {\n          methodName = \"replaceState\";\n          _isFixNavigate = null;\n        }\n\n        history[methodName](\n          {\n            routerMode: 1,\n            routers: routers.map((e) => {\n              return {\n                src: e.src,\n              };\n            }),\n          },\n          \"\",\n          hUrl\n        );\n        break;\n      case \"back\":\n        if (_isBack) {\n          _isBack = null;\n          return;\n        }\n\n        _isFixState = 1;\n        history.go(-delta);\n        break;\n    }\n  });\n\n  let popstateFunc;\n  window.addEventListener(\n    \"popstate\",\n    (popstateFunc = (e) => {\n      const { state } = e;\n\n      if (_isFixState) {\n        _isFixState = null;\n        return;\n      }\n\n      if (!state) {\n        if (fixStateUrl) {\n          const newPath = fixStateUrl();\n          if (newPath) {\n            _isFixNavigate = 1;\n            cancelAnime(app, () => app.goto(newPath));\n            return;\n          }\n\n          if (newPath === false) {\n            return;\n          }\n        }\n\n        _isBack = 1;\n        cancelAnime(app, () => app.back(app.routers.length - 1));\n        return;\n      }\n\n      if (!state.routerMode || state.ignore) {\n        return;\n      }\n\n      const { routers: hisRouters } = state;\n      const { routers: appRouters } = app;\n\n      if (hisRouters.length < appRouters.length) {\n        // history back\n        _isBack = 1;\n        cancelAnime(app, () => app.back(appRouters.length - hisRouters.length));\n      } else if (hisRouters.length > appRouters.length) {\n        // history forward\n        const moreRouters = hisRouters.slice();\n\n        const target = moreRouters.pop();\n\n        if (moreRouters.length > appRouters.length) {\n          const canPushRouters = moreRouters.slice(app._history.length);\n          app._history.push(...canPushRouters);\n        }\n\n        _isGoto = 1;\n\n        cancelAnime(app, () => app.goto(target.src));\n      } else if (JSON.stringify(hisRouters) !== JSON.stringify(appRouters)) {\n        console.error(`o-router error occurred`);\n      }\n    })\n  );\n\n  const isSa = isSafariBrowser();\n\n  const cancelAnime = (app, func) => {\n    isSa && (app._noanime = true);\n    func();\n    isSa && (app._noanime = false);\n  };\n\n  return popstateFunc;\n}\n","import { getType } from \"../stanz/public.mjs\";\n\nexport const isFunction = (val) => getType(val).includes(\"function\");\n\nexport const hyphenToUpperCase = (str) =>\n  str.replace(/-([a-z])/g, (match, p1) => {\n    return p1.toUpperCase();\n  });\n\nexport function capitalizeFirstLetter(str) {\n  return str.charAt(0).toUpperCase() + str.slice(1);\n}\n\nexport const isArrayEqual = (arr1, arr2) => {\n  if (arr1.length !== arr2.length) {\n    return false;\n  }\n  for (let i = 0, len = arr1.length; i < len; i++) {\n    if (arr1[i] !== arr2[i]) {\n      return false;\n    }\n  }\n  return true;\n};\n\nexport const toDashCase = (str) => {\n  return str.replace(/[A-Z]/g, function (match) {\n    return \"-\" + match.toLowerCase();\n  });\n};\n\n// Determine if an element is eligible\nexport const meetsEle = (ele, expr) => {\n  const temp = document.createElement(\"template\");\n  temp.content.append(ele.cloneNode());\n  return !!temp.content.querySelector(expr);\n};\n\nexport function isEmptyObject(obj) {\n  if (!obj) {\n    return false;\n  }\n  for (var key in obj) {\n    if (obj.hasOwnProperty(key)) {\n      return false;\n    }\n  }\n  return true;\n}\n\nexport function moveArrayValue(arr, oldValue, newIndex) {\n  const oldIndex = arr.indexOf(oldValue);\n\n  if (oldIndex === -1) {\n    throw new Error(\"Value not found in array\");\n  }\n\n  arr.splice(newIndex, 0, arr.splice(oldIndex, 1)[0]);\n  return arr;\n}\n\nexport const removeArrayValue = (arr, target) => {\n  const index = arr.indexOf(target);\n  if (index > -1) {\n    arr.splice(index, 1);\n  }\n};\n\nexport const searchEle = (el, expr) => {\n  if (el instanceof HTMLTemplateElement) {\n    return Array.from(el.content.querySelectorAll(expr));\n  }\n  return Array.from(el.querySelectorAll(expr));\n};\n\nexport function mergeObjects(obj1, obj2) {\n  for (let key of Object.keys(obj1)) {\n    if (!obj2.hasOwnProperty(key)) {\n      delete obj1[key];\n    }\n  }\n\n  for (let [key, value] of Object.entries(obj2)) {\n    obj1[key] = value;\n  }\n}\n\nexport const isSafariBrowser = () =>\n  /^((?!chrome|android).)*safari/i.test(navigator.userAgent);\n","import { getRandomId } from \"../../packages/stanz/public.mjs\";\nimport initRouter from \"./init-router.mjs\";\n\nconst FIXBODY = `f-${getRandomId()}`;\n\n$.register({\n  tag: \"o-router\",\n  temp: `<style>:host{display:block;width:100%;height:100%;overflow:hidden}::slotted(o-app){width:100%;height:100%}</style><slot></slot>`,\n  attrs: {\n    fixBody: null,\n  },\n  watch: {\n    fixBody(val) {\n      if (val !== null) {\n        const styleEle = document.createElement(\"style\");\n        styleEle.setAttribute(FIXBODY, \"\");\n        styleEle.innerHTML = `html,body{margin:0;padding:0;width:100%;height:100%;}`;\n        document.head.append(styleEle);\n      } else {\n        const target = document.head.querySelector(FIXBODY);\n        if (target) {\n          target.remove();\n        }\n      }\n    },\n  },\n  attached() {\n    const app = this.$(\"o-app\");\n\n    if (!history.state && window.location.hash) {\n      app.$(\"o-page\")?.remove();\n      // app.goto(new URL(location.hash.replace(\"#\", \"\"), location.href).href);\n      app.goto(location.hash.replace(\"#\", \"\"));\n    }\n\n    this._popstateFunc = initRouter({\n      app,\n      fixStateUrl() {\n        const urlObj = new URL(location.href);\n\n        if (urlObj.hash) {\n          return urlObj.hash.replace(\"#\", \"\");\n        }\n      },\n    });\n  },\n  detached() {\n    if (this._popstateFunc) {\n      window.removeEventListener(\"popstate\", this._popstateFunc);\n    }\n  },\n});\n\n$.extensions.link = ($el) => {\n  if ($el.attr(\"olink\") === \"\") {\n    const href = $el.attr(\"href\");\n\n    let urlObj;\n    try {\n      urlObj = new URL(href);\n    } catch (err) {\n      return;\n    }\n\n    if (!/^#\\//.test(urlObj.hash)) {\n      $el.attr(\"origin-href\", href);\n\n      const linkUrlObj = new URL(href);\n\n      $el.attr(\n        \"href\",\n        `${location.origin}${location.pathname}#${linkUrlObj.pathname}`\n      );\n    }\n  }\n};\n"],"names":["document","currentScript","attributes","hasOwnProperty","Set","initRouter","app","getStateUrl","fixStateUrl","_isFixState","_isGoto","_isBack","_isFixNavigate","popstateFunc","history","state","routerMode","routers","on","e","methodName","name","delta","src","data","pathname","search","origin","URL","location","href","hUrl","map","go","window","addEventListener","newPath","cancelAnime","goto","back","length","ignore","hisRouters","appRouters","moreRouters","slice","target","pop","canPushRouters","_history","push","JSON","stringify","console","error","isSa","test","navigator","userAgent","func","_noanime","FIXBODY","Math","random","toString","$","register","tag","temp","attrs","fixBody","watch","val","styleEle","createElement","setAttribute","innerHTML","head","append","querySelector","remove","attached","this","hash","replace","_popstateFunc","urlObj","detached","removeEventListener","extensions","link","$el","attr","err","linkUrlObj"],"mappings":"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"}