{"version":3,"file":"router.min.js","sources":["../../../packages/stanz/public.mjs","../router.mjs","../init-router.mjs"],"sourcesContent":["export const getRandomId = () => Math.random().toString(32).slice(2);\n\nconst objectToString = Object.prototype.toString;\nexport const getType = (value) =>\n  objectToString\n    .call(value)\n    .toLowerCase()\n    .replace(/(\\[object )|(])/g, \"\");\n\nexport const isObject = (obj) => {\n  const type = getType(obj);\n  return type === \"array\" || type === \"object\";\n};\n\nconst tickSets = new Set();\nexport function nextTick(callback) {\n  const tickId = `t-${getRandomId()}`;\n  tickSets.add(tickId);\n  Promise.resolve().then(() => {\n    if (tickSets.has(tickId)) {\n      callback();\n      tickSets.delete(tickId);\n    }\n  });\n  return tickId;\n}\nexport const clearTick = (id) => tickSets.delete(id);\n\nexport function debounce(func, wait = 0) {\n  let timeout = null;\n  let hisArgs = [];\n\n  return function (...args) {\n    hisArgs.push(...args);\n\n    if (wait > 0) {\n      clearTimeout(timeout);\n      timeout = setTimeout(() => {\n        func.call(this, hisArgs);\n        hisArgs = [];\n        timeout = null;\n      }, wait);\n    } else {\n      if (timeout === null) {\n        timeout = 1;\n        nextTick(() => {\n          func.call(this, hisArgs);\n          hisArgs = [];\n          timeout = null;\n        });\n      }\n    }\n  };\n}\n\n// Enhanced methods for extending objects\nexport const extend = (_this, proto, descriptor = {}) => {\n  [\n    ...Object.getOwnPropertyNames(proto),\n    ...Object.getOwnPropertySymbols(proto),\n  ].forEach((k) => {\n    const result = Object.getOwnPropertyDescriptor(proto, k);\n    const { configurable, enumerable, writable, get, set, value } = result;\n\n    if (\"value\" in result) {\n      if (_this.hasOwnProperty(k)) {\n        _this[k] = value;\n      } else {\n        Object.defineProperty(_this, k, {\n          enumerable,\n          configurable,\n          writable,\n          ...descriptor,\n          value,\n        });\n      }\n    } else {\n      Object.defineProperty(_this, k, {\n        enumerable,\n        configurable,\n        ...descriptor,\n        get,\n        set,\n      });\n    }\n  });\n\n  return _this;\n};\n","import { getRandomId } from \"../../packages/stanz/public.mjs\";\nimport initRouter from \"./init-router.mjs\";\n\nconst FIXBODY = `f-${getRandomId()}`;\n\n$.register({\n  tag: \"o-router\",\n  temp: `<style>:host{display:block;width:100%;height:100%;overflow:hidden}::slotted(o-app){display:block;width:100%;height:100%}</style><slot></slot>`,\n  attrs: {\n    fixBody: null,\n  },\n  watch: {\n    fixBody(val) {\n      if (val !== null) {\n        const styleEle = document.createElement(\"style\");\n        styleEle.setAttribute(FIXBODY, \"\");\n        styleEle.innerHTML = `html,body{margin:0;padding:0;width:100%;height:100%;}`;\n        document.head.append(styleEle);\n      } else {\n        const target = document.head.querySelector(FIXBODY);\n        if (target) {\n          target.remove();\n        }\n      }\n    },\n  },\n  attached() {\n    const app = this.$(\"o-app\");\n\n    if (!history.state && window.location.hash) {\n      app.$(\"o-page\")?.remove();\n      // app.goto(new URL(location.hash.replace(\"#\", \"\"), location.href).href);\n      app.goto(location.hash.replace(\"#\", \"\"));\n    }\n\n    this._popstateFunc = initRouter({\n      app,\n      fixStateUrl() {\n        const urlObj = new URL(location.href);\n\n        if (urlObj.hash) {\n          return urlObj.hash.replace(\"#\", \"\");\n        }\n      },\n    });\n  },\n  detached() {\n    if (this._popstateFunc) {\n      window.removeEventListener(\"popstate\", this._popstateFunc);\n    }\n  },\n});\n\n$.extensions.link = ($el) => {\n  if ($el.attr(\"olink\") === \"\") {\n    const href = $el.attr(\"href\");\n\n    let urlObj;\n    try {\n      urlObj = new URL(href);\n    } catch (err) {\n      return;\n    }\n\n    if (!/^#\\//.test(urlObj.hash)) {\n      $el.attr(\"origin-href\", href);\n\n      const linkUrlObj = new URL(href);\n\n      $el.attr(\n        \"href\",\n        `${location.origin}${location.pathname}#${linkUrlObj.pathname}`\n      );\n    }\n  }\n};\n","export default function initRouter({ app, getStateUrl, fixStateUrl }) {\n  if (history.state && history.state.routerMode) {\n    app.routers = history.state.routers;\n  }\n\n  // Application fallback, no window.history operation required\n  let _isFixState;\n  // When history moves forward\n  let _isGoto;\n  // When the address is back\n  let _isBack;\n  // when there is historical data, re-entering the hash address, it is necessary to replace the blank history\n  let _isFixNavigate;\n\n  app.on(\"router-change\", (e) => {\n    let methodName = \"pushState\";\n    switch (e.name) {\n      case \"replace\":\n        methodName = \"replaceState\";\n      case \"goto\":\n        const { routers } = app;\n\n        const { pathname, search } = new URL(e.src, location.href);\n\n        if (_isGoto) {\n          _isGoto = null;\n          return;\n        }\n\n        const hUrl = getStateUrl\n          ? getStateUrl(pathname, search, methodName)\n          : `#${pathname}${search}`;\n\n        if (_isFixNavigate) {\n          methodName = \"replaceState\";\n          _isFixNavigate = null;\n        }\n\n        history[methodName](\n          {\n            routerMode: 1,\n            routers: routers.map((e) => {\n              return {\n                src: e.src,\n              };\n            }),\n          },\n          \"\",\n          hUrl\n        );\n        break;\n      case \"back\":\n        if (_isBack) {\n          _isBack = null;\n          return;\n        }\n\n        _isFixState = 1;\n        history.go(-e.delta);\n        break;\n    }\n  });\n\n  let popstateFunc;\n  window.addEventListener(\n    \"popstate\",\n    (popstateFunc = (e) => {\n      const { state } = e;\n\n      if (_isFixState) {\n        _isFixState = null;\n        return;\n      }\n\n      if (!state) {\n        if (fixStateUrl) {\n          const newPath = fixStateUrl();\n          if (newPath) {\n            _isFixNavigate = 1;\n            app.goto(newPath);\n            return;\n          }\n\n          if (newPath === false) {\n            return;\n          }\n        }\n\n        _isBack = 1;\n        app.back(app.routers.length - 1);\n        return;\n      }\n\n      if (!state.routerMode || state.ignore) {\n        return;\n      }\n\n      const { routers: hisRouters } = state;\n      const { routers: appRouters } = app;\n\n      if (hisRouters.length < appRouters.length) {\n        // history back\n        _isBack = 1;\n        app.back(appRouters.length - hisRouters.length);\n      } else if (hisRouters.length > appRouters.length) {\n        // history forward\n        const moreRouters = hisRouters.slice();\n\n        const target = moreRouters.pop();\n\n        if (moreRouters.length > appRouters.length) {\n          const canPushRouters = moreRouters.slice(app._history.length);\n          app._history.push(...canPushRouters);\n        }\n\n        _isGoto = 1;\n\n        app.goto(target.src);\n      } else if (JSON.stringify(hisRouters) !== JSON.stringify(appRouters)) {\n        console.error(`o-router error occurred`);\n      }\n    })\n  );\n\n  return popstateFunc;\n}\n"],"names":["Set","FIXBODY","Math","random","toString","slice","$","register","tag","temp","attrs","fixBody","watch","val","styleEle","document","createElement","setAttribute","innerHTML","head","append","target","querySelector","remove","attached","app","this","history","state","window","location","hash","goto","replace","_popstateFunc","getStateUrl","fixStateUrl","_isFixState","_isGoto","_isBack","_isFixNavigate","popstateFunc","routerMode","routers","on","e","methodName","name","pathname","search","URL","src","href","hUrl","map","go","delta","addEventListener","newPath","back","length","ignore","hisRouters","appRouters","moreRouters","pop","canPushRouters","_history","push","JSON","stringify","console","error","initRouter","urlObj","detached","removeEventListener","extensions","link","$el","attr","err","test","linkUrlObj","origin"],"mappings":"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"}