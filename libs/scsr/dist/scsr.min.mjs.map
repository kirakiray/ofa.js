{"version":3,"file":"scsr.min.mjs","sources":["../scsr.mjs","../../router/init-router.mjs"],"sourcesContent":["import initRouter from \"../router/init-router.mjs\";\n\n(() => {\n  async function ready() {\n    const app = $(\"o-app\");\n    $(\"o-app template[page]\").remove();\n\n    app.on(\"page-loaded\", (e) => {\n      const { _defaults } = $(e.target);\n\n      if (typeof _defaults.title === \"string\") {\n        const titleEl = $(\"head title\");\n        titleEl && (titleEl.text = _defaults.title);\n      }\n    });\n\n    app.push(`<o-page src=\"${location.pathname}\"></o-page>`);\n\n    initRouter(app, (pathname, search) => {\n      return `${pathname}${search}`;\n    });\n  }\n\n  if (document.readyState === \"complete\") {\n    ready();\n  } else {\n    $(window).one(\"load\", () => {\n      ready();\n    });\n  }\n})();\n","export default function initRouter(app, getStateUrl) {\n  if (history.state && history.state.routerMode) {\n    app.routers = history.state.routers;\n  }\n\n  let _isFixState = 0;\n  let _isGoto;\n  let _isBack;\n\n  app.on(\"router-change\", (e) => {\n    let methodName = \"pushState\";\n    switch (e.name) {\n      case \"replace\":\n        methodName = \"replaceState\";\n      case \"goto\":\n        const { routers } = app;\n\n        const { pathname, search } = new URL(e.src, location.href);\n\n        if (_isGoto) {\n          _isGoto = null;\n          return;\n        }\n\n        const hUrl = getStateUrl\n          ? getStateUrl(pathname, search, methodName)\n          : `#${pathname}${search}`;\n\n        history[methodName](\n          {\n            routerMode: 1,\n            routers: routers.map((e) => {\n              return {\n                tag: e.tag,\n                src: e.src,\n              };\n            }),\n          },\n          \"\",\n          hUrl\n        );\n        break;\n      case \"back\":\n        if (_isBack) {\n          _isBack = null;\n          return;\n        }\n\n        _isFixState = 1;\n        history.go(-e.delta);\n        break;\n    }\n  });\n\n  let popstateFunc;\n  window.addEventListener(\n    \"popstate\",\n    (popstateFunc = (e) => {\n      const { state } = e;\n\n      if (_isFixState) {\n        _isFixState = 0;\n        return;\n      }\n\n      if (!state) {\n        _isBack = 1;\n        app.back(app.routers.length - 1);\n        return;\n      }\n\n      const { routers: hisRouters } = state;\n      const { routers: appRouters } = app;\n\n      if (hisRouters.length < appRouters.length) {\n        // history back\n        _isBack = 1;\n        app.back(appRouters.length - hisRouters.length);\n      } else if (hisRouters.length > appRouters.length) {\n        // history forward\n        const moreRouters = hisRouters.slice();\n\n        const target = moreRouters.pop();\n\n        if (moreRouters.length > appRouters.length) {\n          const canPushRouters = moreRouters.slice(app._history.length);\n          app._history.push(...canPushRouters);\n        }\n\n        _isGoto = 1;\n\n        app.goto(target.src);\n      } else {\n        console.error(`o-router error occurred`);\n      }\n    })\n  );\n\n  return popstateFunc;\n}\n"],"names":["async","ready","app","$","remove","on","e","_defaults","target","title","titleEl","text","push","location","pathname","getStateUrl","history","state","routerMode","routers","_isGoto","_isBack","popstateFunc","_isFixState","methodName","name","search","URL","src","href","hUrl","map","tag","go","delta","window","addEventListener","back","length","hisRouters","appRouters","moreRouters","slice","pop","canPushRouters","_history","goto","console","error","initRouter","document","readyState","one"],"mappings":";AAEA,MACEA,eAAeC,IACb,MAAMC,EAAMC,EAAE,SACdA,EAAE,wBAAwBC,SAE1BF,EAAIG,GAAG,eAAgBC,IACrB,MAAMC,UAAEA,GAAcJ,EAAEG,EAAEE,QAE1B,GAA+B,iBAApBD,EAAUE,MAAoB,CACvC,MAAMC,EAAUP,EAAE,cAClBO,IAAYA,EAAQC,KAAOJ,EAAUE,MACtC,KAGHP,EAAIU,KAAK,gBAAgBC,SAASC,uBChBvB,SAAoBZ,EAAKa,GAClCC,QAAQC,OAASD,QAAQC,MAAMC,aACjChB,EAAIiB,QAAUH,QAAQC,MAAME,SAG9B,IACIC,EACAC,EA+CAC,EAjDAC,EAAc,EAIlBrB,EAAIG,GAAG,iBAAkBC,IACvB,IAAIkB,EAAa,YACjB,OAAQlB,EAAEmB,MACR,IAAK,UACHD,EAAa,eACf,IAAK,OACH,MAAML,QAAEA,GAAYjB,GAEdY,SAAEA,EAAQY,OAAEA,GAAW,IAAIC,IAAIrB,EAAEsB,IAAKf,SAASgB,MAErD,GAAIT,EAEF,YADAA,EAAU,MAIZ,MAAMU,EAAOf,EACTA,EAAYD,EAAUY,EAAQF,GAC9B,IAAIV,IAAWY,IAEnBV,QAAQQ,GACN,CACEN,WAAY,EACZC,QAASA,EAAQY,KAAKzB,IACb,CACL0B,IAAK1B,EAAE0B,IACPJ,IAAKtB,EAAEsB,SAIb,GACAE,GAEF,MACF,IAAK,OACH,GAAIT,EAEF,YADAA,EAAU,MAIZE,EAAc,EACdP,QAAQiB,IAAI3B,EAAE4B,OAEjB,IAIHC,OAAOC,iBACL,WACCd,EAAgBhB,IACf,MAAMW,MAAEA,GAAUX,EAElB,GAAIiB,EAEF,YADAA,EAAc,GAIhB,IAAKN,EAGH,OAFAI,EAAU,OACVnB,EAAImC,KAAKnC,EAAIiB,QAAQmB,OAAS,GAIhC,MAAQnB,QAASoB,GAAetB,GACxBE,QAASqB,GAAetC,EAEhC,GAAIqC,EAAWD,OAASE,EAAWF,OAEjCjB,EAAU,EACVnB,EAAImC,KAAKG,EAAWF,OAASC,EAAWD,aACnC,GAAIC,EAAWD,OAASE,EAAWF,OAAQ,CAEhD,MAAMG,EAAcF,EAAWG,QAEzBlC,EAASiC,EAAYE,MAE3B,GAAIF,EAAYH,OAASE,EAAWF,OAAQ,CAC1C,MAAMM,EAAiBH,EAAYC,MAAMxC,EAAI2C,SAASP,QACtDpC,EAAI2C,SAASjC,QAAQgC,EACtB,CAEDxB,EAAU,EAEVlB,EAAI4C,KAAKtC,EAAOoB,IACxB,MACQmB,QAAQC,MAAM,0BACf,EAKP,CDjFIC,CAAW/C,GAAK,CAACY,EAAUY,IAClB,GAAGZ,IAAWY,KAExB,CAE2B,aAAxBwB,SAASC,WACXlD,IAEAE,EAAEgC,QAAQiB,IAAI,QAAQ,KACpBnD,GAAO,GAGZ,EA5BD"}