{"version":3,"file":"scsr.min.js","sources":["../scsr.mjs","../../router/init-router.mjs"],"sourcesContent":["import initRouter from \"../router/init-router.mjs\";\n\n(() => {\n  async function ready() {\n    const app = $(\"o-app\");\n    $(\"o-app template[page]\")?.remove();\n\n    let maybeHash = false;\n    window.addEventListener(\"hashchange\", (e) => {\n      if (maybeHash) {\n        const urlObj = new URL(location.href);\n\n        const { routers } = app;\n\n        history.replaceState(\n          {\n            routerMode: 1,\n            ignore: 1,\n            routers: routers.map((e) => {\n              return {\n                src: e.src,\n              };\n            }),\n          },\n          \"\",\n          urlObj.hash\n        );\n      }\n    });\n\n    app.on(\"page-loaded\", (e) => {\n      const { _defaults } = $(e.target);\n\n      if (typeof _defaults.title === \"string\") {\n        const titleEl = $(\"head title\");\n        titleEl && (titleEl.text = _defaults.title);\n      }\n    });\n\n    if (!history?.state?.routerMode) {\n      app.push(`<o-page src=\"${location.pathname}\"></o-page>`);\n    }\n\n    initRouter({\n      app,\n      getStateUrl(pathname, search) {\n        return `${pathname}${search}`;\n      },\n      fixStateUrl(e) {\n        const urlObj = new URL(location.href);\n\n        if (urlObj.hash) {\n          // 可能是hash锚地\n          maybeHash = true;\n          setTimeout(() => (maybeHash = false));\n          return false;\n        }\n      },\n    });\n  }\n\n  if (document.readyState === \"complete\") {\n    ready();\n  } else {\n    $(window).one(\"load\", () => {\n      ready();\n    });\n  }\n})();\n","export default function initRouter({ app, getStateUrl, fixStateUrl }) {\n  if (history.state && history.state.routerMode) {\n    app.routers = history.state.routers;\n  }\n\n  // Application fallback, no window.history operation required\n  let _isFixState;\n  // When history moves forward\n  let _isGoto;\n  // When the address is back\n  let _isBack;\n  // when there is historical data, re-entering the hash address, it is necessary to replace the blank history\n  let _isFixNavigate;\n\n  app.on(\"router-change\", (e) => {\n    let methodName = \"pushState\";\n    const { name, delta, src } = e.data || {};\n\n    switch (name) {\n      case \"replace\":\n        methodName = \"replaceState\";\n      case \"goto\":\n        const { routers } = app;\n\n        const { pathname, search } = new URL(src, location.href);\n\n        if (_isGoto) {\n          _isGoto = null;\n          return;\n        }\n\n        const hUrl = getStateUrl\n          ? getStateUrl(pathname, search, methodName)\n          : `#${pathname}${search}`;\n\n        if (_isFixNavigate) {\n          methodName = \"replaceState\";\n          _isFixNavigate = null;\n        }\n\n        history[methodName](\n          {\n            routerMode: 1,\n            routers: routers.map((e) => {\n              return {\n                src: e.src,\n              };\n            }),\n          },\n          \"\",\n          hUrl\n        );\n        break;\n      case \"back\":\n        if (_isBack) {\n          _isBack = null;\n          return;\n        }\n\n        _isFixState = 1;\n        history.go(-delta);\n        break;\n    }\n  });\n\n  let popstateFunc;\n  window.addEventListener(\n    \"popstate\",\n    (popstateFunc = (e) => {\n      const { state } = e;\n\n      if (_isFixState) {\n        _isFixState = null;\n        return;\n      }\n\n      if (!state) {\n        if (fixStateUrl) {\n          const newPath = fixStateUrl();\n          if (newPath) {\n            _isFixNavigate = 1;\n            app.goto(newPath);\n            return;\n          }\n\n          if (newPath === false) {\n            return;\n          }\n        }\n\n        _isBack = 1;\n        app.back(app.routers.length - 1);\n        return;\n      }\n\n      if (!state.routerMode || state.ignore) {\n        return;\n      }\n\n      const { routers: hisRouters } = state;\n      const { routers: appRouters } = app;\n\n      if (hisRouters.length < appRouters.length) {\n        // history back\n        _isBack = 1;\n        app.back(appRouters.length - hisRouters.length);\n      } else if (hisRouters.length > appRouters.length) {\n        // history forward\n        const moreRouters = hisRouters.slice();\n\n        const target = moreRouters.pop();\n\n        if (moreRouters.length > appRouters.length) {\n          const canPushRouters = moreRouters.slice(app._history.length);\n          app._history.push(...canPushRouters);\n        }\n\n        _isGoto = 1;\n\n        app.goto(target.src);\n      } else if (JSON.stringify(hisRouters) !== JSON.stringify(appRouters)) {\n        console.error(`o-router error occurred`);\n      }\n    })\n  );\n\n  return popstateFunc;\n}\n"],"names":["async","ready","app","$","remove","maybeHash","window","addEventListener","e","urlObj","URL","location","href","routers","history","replaceState","routerMode","ignore","map","src","hash","on","_defaults","target","title","titleEl","text","state","push","pathname","getStateUrl","fixStateUrl","_isFixState","_isGoto","_isBack","_isFixNavigate","popstateFunc","methodName","name","delta","data","search","hUrl","go","newPath","goto","back","length","hisRouters","appRouters","moreRouters","slice","pop","canPushRouters","_history","JSON","stringify","console","error","initRouter","setTimeout","document","readyState","one"],"mappings":"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"}